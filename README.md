# THM-Writeup-Wazuh  
Writeup for TryHackMe Wazuh Lab - Advanced rule creation, decoder configuration, and threat detection for enhanced log analysis using Wazuh.  

**By Ramyar Daneshgar**

---

### **Introduction**  

In this lab, I explored the advanced capabilities of **Wazuh**, a security monitoring platform built on the ELK stack, to create custom detection rules and decoders tailored to unique scenarios. The goal was to ensure that Wazuh could accurately detect threats while addressing the specific needs of an organization. Each step in this process, from configuring decoders to writing custom rules, was guided by the need to maximize detection efficiency, reduce false positives, and align security configurations with attack scenarios.  

---

### **Decoders: Structuring Raw Logs**  

#### Purpose:  
Decoders are essential for transforming unstructured log data into actionable fields that can be evaluated by Wazuh’s rules. Without decoders, Wazuh wouldn’t be able to make sense of the raw logs, rendering rules ineffective.  

#### Process and Reasoning:  
- **Understanding Pre-Configured Decoders:**  
   I examined the `windows_decoders.xml` file, specifically focusing on the `Sysmon-EventID#1_new` decoder. This decoder is designed to parse logs generated by Sysmon and extract critical fields like event ID.  
   The regex in the decoder is carefully crafted to extract meaningful data:
   ```xml
   <regex>Microsoft-Windows-Sysmon/Operational: \S+\((\d+)\)</regex>
   ```
   For example, this pattern identifies and extracts the event ID `1` from Sysmon logs. Event IDs are critical because they categorize events, enabling downstream rules to focus on relevant scenarios.  

- **Testing Decoder Output:**  
   I used the **Ruleset Test** tool to test a sample Sysmon log:  
   ```
   Image: C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
   ```
   The decoder successfully extracted fields such as `commandLine`, `processGuid`, and `image`. This confirmed that the decoder was functioning as intended and was capable of parsing data accurately.  

#### Reasoning Behind Testing:  
Testing ensures that the decoder is extracting fields correctly. Without this validation, rules relying on these fields may fail or generate false positives. This step demonstrates the importance of ensuring that foundational configurations, like decoders, are functioning correctly before moving to more complex configurations.  

---

### **Rules: Defining Threat Detection Criteria**  

#### Purpose:  
Rules leverage the structured data from decoders to identify specific threats. These rules are the heart of Wazuh’s detection capability, as they define the conditions under which alerts are triggered. My goal here was to understand how existing rules operate and simulate a real-world scenario to test their effectiveness.  

#### Process and Reasoning:  
- **Analyzing Pre-Configured Rules:**  
   I reviewed rule `184666` from the `sysmon_rules.xml` file, which is designed to detect suspicious usage of the `svchost.exe` process.  
   ```xml
   <rule id="184666" level="12">
       <field name="sysmon.image">svchost.exe</field>
       <description>Sysmon - Suspicious Process - svchost.exe</description>
   </rule>
   ```
   This rule targets a common attack vector, as `svchost.exe` is often exploited for process injection. The rule assigns a severity level of `12`, indicating high importance, and is mapped to the MITRE ATT&CK technique `T1055`.  

- **Simulating a Threat Scenario:**  
   To test the rule, I modified a test log to include the `svchost.exe` process:  
   ```
   Image: C:\WINDOWS\system32\svchost.exe
   ```
   When processed through the **Ruleset Test**, the rule triggered as expected.  

   **Key Results:**  
   - **Rule ID:** `184666`  
   - **Severity Level:** `12`  
   - **MITRE Technique:** `T1055 (Process Injection)`  

#### Reasoning Behind the Simulation:  
This simulation mimicked a real-world attack scenario to validate the rule’s effectiveness. By ensuring that the rule triggered under the expected conditions, I confirmed that it could reliably detect this specific threat vector in operational settings.  

---

### **Rule Order: Establishing Logical Hierarchies**  

#### Purpose:  
Rules are processed hierarchically, meaning parent rules must trigger before child rules. This hierarchical structure ensures that alerts are processed logically, reducing unnecessary noise and prioritizing relevant threats.  

#### Process and Reasoning:  
- **Understanding Dependencies:**  
   I explored the relationship between rules `184716` (parent) and `184717` (child). The parent rule acts as a general filter, ensuring that only relevant events are passed to the child rule for further evaluation.  

- **Testing Rule Hierarchy:**  
   To test the dependency, I edited a test log to include:
   ```
   ParentImage: C:\Windows\services.exe
   ```
   This log modification ensured that both the parent and child rules triggered sequentially.  

#### Reasoning Behind Dependencies:  
Dependencies like `if_group` and `if_sid` ensure that Wazuh evaluates rules in a logical sequence. This reduces false positives and focuses detection efforts on meaningful events, improving overall system efficiency.  

---

### **Custom Rules: Tailoring Detection for Specific Needs**  

#### Purpose:  
Pre-configured rules are generic and may not cover all scenarios relevant to a specific organization. Custom rules enable tailored detection, such as monitoring sensitive directories or specific file types.  

#### Process and Reasoning:  
- **Creating a Custom Rule:**  
   I wrote a custom rule to detect file creation in directories like `tmp` or `downloads`, which are often exploited for malicious activity:  
   ```xml
   <rule id="100002" level="3">
       <field name="audit.cwd">tmp|downloads</field>
       <description>File created in a sensitive directory: $(audit.cwd)</description>
   </rule>
   ```
   This rule focuses on directories commonly targeted by attackers for storing malicious files.  

- **Testing the Custom Rule:**  
   I tested the rule with a sample `auditd` log indicating a file creation event in `/tmp`. The rule triggered successfully, generating an alert with:  
   - **ID:** `100002`  
   - **Description:** `File created in a sensitive directory`.  

#### Reasoning Behind Customization:  
Custom rules address specific risks that generic rules cannot. In this case, the rule provides enhanced monitoring of directories likely to be exploited by attackers.  

---

### **Fine-Tuning: Refining Rules for Precision**  

#### Purpose:  
Fine-tuning rules ensures that they are both specific and efficient, reducing false positives while maintaining robust detection capabilities.  

#### Process and Reasoning:  
- **Adding Specificity:**  
   I expanded the custom rule to detect suspicious file extensions, such as `.py` and `.sh`:  
   ```xml
   <rule id="100003" level="12">
       <if_sid>100002</if_sid>
       <field name="audit.file.name">.py|.sh</field>
       <description>Suspicious file created: $(audit.file.name)</description>
   </rule>
   ```
   This addition targets files that are more likely to be malicious scripts.  

- **Incorporating Exceptions:**  
   To avoid false positives, I added an exception for a known benign file used in red team exercises:  
   ```xml
   <rule id="100006" level="0">
       <if_sid>100003</if_sid>
       <field name="audit.file.name">malware-checker.py</field>
       <description>False positive for red team activity.</description>
   </rule>
   ```  

#### Reasoning Behind Fine-Tuning:  
By adding specificity and exceptions, the rule set becomes more precise, reducing noise while maintaining a strong focus on real threats.  

---

### **Lessons Learned**  

1. **Regex Proficiency is Critical:** Regex is at the core of both decoders and rules, making it essential for accurate log parsing and threat detection.  
2. **Dependencies Reduce Noise:** Hierarchical rule processing ensures that alerts are relevant and logically structured.  
3. **Iterative Testing is Key:** Regular testing validates the effectiveness of rules and highlights areas for improvement.  
4. **Customization Enhances Relevance:** Tailored rules address organizational risks more effectively than generic configurations.  

